<!DOCTYPE HTML>
<html lang="en">


<!-- Mirrored from wp.alithemes.com/html/evara/evara-backend/page-orders-1.html by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 01 Aug 2021 15:33:21 GMT -->

<head>
    <meta charset="utf-8">
    <title>Evara Dashboard</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title" content="">
    <meta property="og:type" content="">
    <meta property="og:url" content="">
    <meta property="og:image" content="">
    <!-- Favicon -->
    <link rel="shortcut icon" type="image/x-icon" href="/assetsAdmin/imgs/theme/favicon.svg">
    <!-- Template CSS -->
    <link href="/assetsAdmin/css/main.css" rel="stylesheet" type="text/css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
</head>

<body>
    <main class="main">
        <div class="page-header breadcrumb-wrap">
            <div class="container">
                <div class="breadcrumb">
                    <a href="/" rel="nofollow">Home</a>
                    <span></span> Profile
                    <span></span> Order detail
                </div>
            </div>
        </div>
        <section class="content-main col-md-11">
            <div class="content-header">
                <h2 class="content-title">Profile setting </h2>
            </div>
            <div class="card">
                <div class="card-body">
                    <div class="row gx-5">
                        <aside class="col-lg-3 border-end">
                            <nav class="nav nav-pills flex-lg-column mb-4">
                                <a class="nav-link " aria-current="page" href="/profile">General</a>
                                <a class="nav-link active" href="/my_orders">Orders</a>
                                <a class="nav-link" href="/adresses">My Address</a>
                                <a class="nav-link" href="/wallet">Wallet</a>
                                <a class="nav-link" href="/logout">Log out</a>
                            </nav>
                        </aside>
                        <div class="col-lg-9">
                            <section class="content-body p-xl-4">
                                <div class="content-header">
                                    <div>
                                        <h2 class="content-title card-title">Order detail</h2>
                                        <p>Details for Order ID: {{myOrderDetails._id}}</p>
                                    </div>
                                </div>
                                <div class="card">
                                    <header class="card-header">
                                        <div class="row align-items-center">
                                            <div class="col-lg-6 col-md-6 mb-lg-0 mb-15">
                                                <span>
                                                    <i class="material-icons md-calendar_today"></i>
                                                    <b>{{myOrderDetails.date}}</b>
                                                </span> <br>
                                                <small class="text-muted">Order ID: {{myOrderDetails._id}}</small>
                                            </div>
                                            <div class="col-lg-6 col-md-6 ms-auto text-md-end">

                                                <a onclick="getInvoice('{{myOrderDetails._id}}')"
                                                    class="btn btn-secondary print ms-2" href="#"><i
                                                        class="icon material-icons md-print"></i></a>
                                            <input type="hidden" name="order_id" value="{{myOrderDetails._id}}">
                                            </div>
                                        </div>
                                    </header> <!-- card-header end// -->
                                    <div class="card-body">
                                        <div class="row mb-50 mt-20 order-info-wrap">
                                            <div class="col-md-4">
                                                <article class="icontext align-items-start">
                                                    <span class="icon icon-sm rounded-circle bg-primary-light">
                                                        <i class="text-primary material-icons md-person"></i>
                                                    </span>
                                                    <div class="text">
                                                        <h6 class="mb-1">Customer</h6>
                                                        <p class="mb-1">
                                                            {{address.name}} <br> {{address.mobile}}
                                                        </p>
                                                    </div>
                                                </article>
                                            </div> <!-- col// -->
                                            <div class="col-md-4">
                                                <article class="icontext align-items-start">
                                                    <span class="icon icon-sm rounded-circle bg-primary-light">
                                                        <i class="text-primary material-icons md-local_shipping"></i>
                                                    </span>
                                                    <div class="text">
                                                        <h6 class="mb-1">Order info</h6>
                                                        <p class="mb-1">
                                                            Shipping: Fargo express <br> Pay method:
                                                            {{myOrderDetails.paymentMethod}} <br> Status:
                                                            {{myOrderDetails.status}}
                                                        </p>
                                                    </div>
                                                </article>
                                            </div> <!-- col// -->
                                            <div class="col-md-4">
                                                <article class="icontext align-items-start">
                                                    <span class="icon icon-sm rounded-circle bg-primary-light">
                                                        <i class="text-primary material-icons md-place"></i>
                                                    </span>
                                                    <div class="text">
                                                        <h6 class="mb-1">Deliver to</h6>
                                                        <p class="mb-1">
                                                            City: {{address.city}}, {{address.state}}
                                                            <br>{{address.adressLine1}} <br>{{address.adressLine2}}
                                                            <br>Pin: {{address.pin}}
                                                        </p>
                                                    </div>
                                                </article>
                                            </div> <!-- col// -->
                                        </div> <!-- row // -->
                                        <div class="row">
                                            <div class="col-lg-7">
                                                <div class="table-responsive">
                                                    <table class="table">
                                                        <thead>
                                                            <tr>
                                                                <th width="40%">Product</th>
                                                                <th width="20%">Unit Price</th>
                                                                <th width="20%">Quantity</th>
                                                                <th width="20%" class="text-end">Total</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {{#each orderedProDet}}
                                                            <tr>
                                                                <td>
                                                                    <a class="itemside" href="#">
                                                                        <div class="left">
                                                                            <img src="/images/products/{{this.image}}"
                                                                                width="40" height="40" class="img-xs"
                                                                                alt="Item">
                                                                        </div>
                                                                        <div class="info">{{this.name}}</div>
                                                                    </a>
                                                                </td>
                                                                <td> â‚¹{{this.price}} </td>
                                                                <td >{{this.quantity}}  </td>
                                                                
                                                                
                                                                <td class="text-end">{{multiply this.quantity
                                                                    this.price}}</td>
                                                            </tr>
                                                            {{/each}}



                                                            <tr>
                                                                <td colspan="4">
                                                                    <article class="float-end">
                                                                        <dl class="dlist">
                                                                            <dt>Subtotal:</dt>
                                                                            <dd name="amount">{{myOrderDetails.total}}</dd>
                                                                            <input type="hidden" name="total"
                                                                                value="{{myOrderDetails.total}}">
                                                                            <input type="hidden" name="user_wallet" value="{{userData.wallet}}">
                                                                            <input type="hidden" name="pay-method"
                                                                                value="{{myOrderDetails.paymentMethod}}">
                                                                            
                                                                        </dl>
                                                                        {{#if myOrderDetails.coupon}}
                                                                        <dl class="dlist">
                                                                            <dt>Coupon used:</dt>
                                                                            <dd>{{myOrderDetails.coupon}}</dd>
                                                                        </dl>
                                                                        <dl class="dlist">
                                                                            <dt>Discount:</dt>
                                                                            <dd>{{myOrderDetails.discountAmt}}</dd>
                                                                            <input type="hidden" id="coupon"
                                                                                value="{{ myOrderDetails.coupon}}">
                                                                            <input type="hidden"
                                                                                name="amount_after_discount"
                                                                                value="{{myOrderDetails.amountAfterDscnt}}">
                                                                            {{else}}
                                                                            <dl class="dlist">
                                                                                <dt>Coupon used:</dt>
                                                                                <dd>None</dd>
                                                                            </dl>
                                                                            {{/if}}
                                                                        </dl>
                                                                        <dl class="dlist">
                                                                            <dt>Grand total:</dt>
                                                                            {{#if myOrderDetails.amountAfterDscnt}}
                                                                            <dd> <b
                                                                                    class="h5">{{myOrderDetails.amountAfterDscnt}}</b>
                                                                            </dd>
                                                                            {{else}}
                                                                            <dd> <b
                                                                                    class="h5">{{myOrderDetails.total}}</b>
                                                                            </dd>
                                                                            {{/if}}
                                                                        </dl>
                                                                        <dl class="dlist">
                                                                            <dt class="text-muted">Status:</dt>
                                                                            <dd>
                                                                                <span
                                                                                    class="badge rounded-pill alert-success text-success">{{myOrderDetails.status}}</span>
                                                                            </dd>
                                                                        </dl>
                                                                    </article>
                                                                </td>
                                                            </tr>
                                                        </tbody>
                                                    </table>
                                                </div> <!-- table-responsive// -->
                                            </div> <!-- col// -->
                                            <div class="col-lg-1"></div>
                                            <div class="col-lg-4">
                                                <div class="box shadow-sm bg-light">
                                                    <h6 class="mb-15">Payment info</h6>
                                                    <p>
                                                        {{myOrderDetails.paymentMethod}}
                                                    </p>
                                                </div>
                                                <div class="mt-3">
                                                    <a href="/my_orders" type="button"
                                                        class="btn btn-primary">Back</a>
                                                    {{#ifeq myOrderDetails.status 'pending'}}
                                                    <span id="cancel_btn">
                                                        <button onclick="status()" type="button"
                                                            class="btn btn-md rounded font-sm mx-2">
                                                            Cancel order
                                                        </button>
                                                    </span>
                                                    {{/ifeq}}
                                                    {{#ifeq myOrderDetails.status 'Payment Failed'}}
                                                    <span id="cancel_btn">
                                                        <button onclick="status3()" type="button"
                                                            class="btn btn-md rounded font-sm mx-2">
                                                             Retry Payment
                                                        </button>
                                                    </span>
                                                    {{/ifeq}}

                    {{#ifeq myOrderDetails.status 'Delivered'}}
                    <span id="return_btn">
                      <button onclick="status2()" type="button"  class="btn btn-md rounded font-sm mx-2">
                        Return
                      </button>
                    </span>
                    {{/ifeq}}

                    {{#ifeq myOrderDetails.status 'Shipped'}}
                    <span id="cancel_btn">
                      <button onclick="status()" type="button"  class="btn btn-md rounded font-sm mx-2">
                        Cancel order
                      </button>
                    </span>
                    {{/ifeq}}

                                                </div>


                                            </div> <!-- col// -->
                                        </div>
                                    </div> <!-- card-body end// -->
                                </div> <!-- card end// -->
                            </section> <!-- content-main end// -->
                        </div> <!-- col.// -->
                    </div> <!-- row.// -->
                </div> <!-- card body end// -->
            </div> <!-- card end// -->
        </section> <!-- content-main end// -->
    </main>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>

const amount = parseInt({{myOrderDetails.total}} * 100)
  const orderId = document.getElementsByName('order_id')[0].value
  console.log(orderId)

  const status = () => {
        Swal.fire({
        title: 'Are you sure you want cancel?',
        text: "",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: 'Yes, cancel it!',
        cancelButtonText: 'No, keep it',
        dangerMode: true
    }).then((willDelete) => {
        if (willDelete.isConfirmed) {
            changeStatus(orderId, 'cancel', 'Cancelled');
            Swal.fire("Your order was canceled!");
            document.getElementById('cancel_btn').innerHTML = '';
        } else {
            Swal.fire("Your order was not canceled!");
        }
    });
  }



const status2 = () => {
    Swal.fire({
        title: 'Are you sure you want to return?',
        text: "",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: 'Yes, return it!',
        cancelButtonText: 'No, keep it',
        dangerMode: true
    }).then((result) => {
        if (result.isConfirmed) {
            changeStatus(orderId, 'return', 'Returned');
            Swal.fire("Your order was returned!");
            document.getElementById('return_btn').innerHTML = '';
        } else {
            Swal.fire("Your order was not returned!");
        }
    });
}


 const status3 = () => {
        Swal.fire({
        title: 'Are you sure you want retry payment?',
        text: "",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: 'Yes',
        cancelButtonText: 'No',
        dangerMode: true
    }).then((willDelete) => {
        if (willDelete.isConfirmed) {
            payment(orderId)
            //Swal.fire("Retry Payment Successfull!");
        } else {
            Swal.fire("Your order was not canceled!");
        }
    });
  }


const retryPayment = async (id , status) => {
    
    try{
        
    const response = await fetch(`/retry_payment?id=${id}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        
    status : "pending"

      })
    });

    const paymentSuccess = await response.json();
    location.reload()
    if(true){

        Swal.fire({
        title: 'Payment Successful!',
        text: 'Thank you for your purchase.',
        icon: 'success',
        confirmButtonText: 'OK'
    })

    }


        }catch{
            console.error('Error changing status:', error);
        }

}



  const changeStatus = async (id, status, status2) => {
  try {
   

    
    let wallet = Number(document.getElementsByName('user_wallet')[0].value);
    let updatedWallet;

    // Check if a coupon is applied
    if (document.getElementById('coupon') && document.getElementsByName('amount_after_discount')[0]) {
      const amountAfterDiscount = Number(document.getElementsByName('amount_after_discount')[0].value);
      updatedWallet = wallet + amountAfterDiscount;
      console.log('Coupon applied. Amount after discount:', amountAfterDiscount);
    } else {
      // If no coupon, calculate updatedWallet with total amount
      const total = Number(document.getElementsByName('total')[0].value);
      updatedWallet = wallet + total;
    }

    console.log('Updated Wallet:', updatedWallet, 'Original Wallet:', wallet);

    // Retrieve the payment method
    const payMethod = document.getElementsByName('pay-method')[0].value;
    console.log('Payment Method:', payMethod);

    // Make the request to update the order status
    const response = await fetch(`/${status}_order?id=${id}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        updateWallet: updatedWallet,
        payMethod: payMethod
        //{...obj}
      })
    });

    // Parse the JSON response
    const data = await response.json();
    console.log('Response Data:', data);

    // Update the UI based on the response
    if (data) {
      document.getElementById('cancel_btn').innerHTML = '';
      document.getElementById('return_btn').innerHTML = '';
      document.getElementById('order_status').innerText = `${status2}`;
      Swal.fire({
        title:'Your order has been canceled!',
        icon: 'success',
        confirmButtonText: 'OK'
      });
    }
  } catch (error) {
    console.error('Error changing status:', error);
    {{!-- Swal.fire('Oops!', 'Something went wrong. Please try again.', 'error'); --}}
  }
};


  const payment = (id) => {
    //subTotal = Number(document.getElementsByName('total')[0].value)


    var options = {
      "key": "rzp_test_RgbHBDrROekluj", // Enter the Key ID generated from the Dashboard
      "amount": parseInt(amount), // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
      "currency": "INR",

      "name" : "Cake Shop",
      /*"name": "Acme Corp", //your business name
      "description": "Test Transaction",
      "image": "https://example.com/your_logo",*/

      "order_id": undefined, //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
      "handler": function (response) {
        retryPayment(orderId, 'Pending');
      },

    };
    var rzp1 = new Razorpay(options);
    rzp1.on('payment.failed',function(response){
     Swal.fire({
                    icon: 'error',
                    title: 'Payment Failed',
                    text: 'Your payment could not be processed. Please try again later.',
                    confirmButtonText: 'OK'
                }).then((result) => {
                    if (result.isConfirmed) {
                        location.reload()
                    }
                });

    })
    rzp1.open();

  }





const getInvoice = async (id) => {
  try {
    const response = await fetch(`/get_invoice?id=${id}`, {
      method: 'GET',
      headers: {
        'Content-Type': 'application/pdf'
      }
    });

    // Check if the response is successful
    if (!response.ok) {
      throw new Error('Failed to fetch invoice');
    }

    // Get the blob data from the response
    const blob = await response.blob();

    // Create a URL for the downloaded file
    const url = URL.createObjectURL(blob);

    // Create a link element to trigger the download
    const link = document.createElement('a');
    link.href = url;
    link.download = 'invoice.pdf';

    // Trigger the download
    link.click();

    // Clean up the URL object
    URL.revokeObjectURL(url);
  } catch (error) {
    console.error('Error fetching invoice:', error);
    // Handle the error, e.g., display an error message to the user
  }
};






</script>

    <script src="/assetsAdmin/js/vendors/jquery-3.6.0.min.js"></script>
    <script src="/assetsAdmin/js/vendors/bootstrap.bundle.min.js"></script>
    <script src="/assetsAdmin/js/vendors/select2.min.js"></script>
    <script src="/assetsAdmin/js/vendors/perfect-scrollbar.js"></script>
    <script src="/assetsAdmin/js/vendors/jquery.fullscreen.min.js"></script>
    <!-- Main Script -->
    <script src="/assetsAdmin/js/main.js" type="text/javascript"></script>
</body>


<!-- Mirrored from wp.alithemes.com/html/evara/evara-backend/page-orders-1.html by HTTrack Website Copier/3.x [XR&CO'2014], Sun, 01 Aug 2021 15:33:22 GMT -->

</html>